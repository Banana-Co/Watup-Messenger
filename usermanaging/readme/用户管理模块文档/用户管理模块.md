## 用户管理模块

### 后端

#### 用户认证和资源保护模块

采用的是Spring Security + OAuth2的认证模式，并且其中的token是通过 redis存储。

通常的认证逻辑：

- 除了认证相关的资源或者接口之外都是被保护的。
- 用户通过输入用户名和密码进行登录认证，授权服务器授权之后返回token给前端，并保存在redis中。
- 前端拿到token之后保存在store中，之后每次请求接口都需要携带token，如果token过期需要刷新token。

##### Oauth2认证

OAuth 是一个开放标准，该标准允许用户让第三方应用访问该用户在某一网站上存储的私密资源（如头像、照片、视频等），而在这个过程中无需将用户名和密码提供给第三方应用。实现这一功能是通过提供一个令牌（token），而不是用户名和密码来访问他们存放在特定服务提供者的数据。采用令牌（token）的方式可以让用户灵活的对第三方应用授权或者收回权限。

- **授权模式**

  - 授权码模式：常见的第三方平台登录功能基本都是使用这种模式。

  - 简化模式：简化模式是不需要客户端服务器参与，直接在浏览器中向授权服务器申请令牌（token），一般如果网站是纯静态页面则可以采用这种方式。

  - 密码模式：密码模式是用户把用户名密码直接告诉客户端，客户端使用说这些信息向授权服务器申请令牌（token）。这需要用户对客户端高度信任，例如客户端应用和服务提供商就是同一家公司。

  - 客户端模式：客户端模式是指客户端使用自己的名义而不是用户的名义向服务提供者申请授权，严格来说，客户端模式并不能算作 OAuth 协议要解决的问题的一种解决方案，但是，对于开发者而言，在一些前后端分离应用或者为移动端提供的认证授权服务器上使用这种模式还是非常方便的。

    **本项目中我们采用的最基本的就是密码模式，后期如果扩展可以加入授权码模式，例如跳转QQ验证扥登录**

- **重要接口**

  | /oauth/authorize      | 这个是授权的端点                                             |
  | --------------------- | ------------------------------------------------------------ |
  | /oauth/token          | 这个是用来获取令牌的端点                                     |
  | /oauth/confirm_access | 用户确认授权提交的端点（就是 auth-server 询问用户是否授权那个页面的提交地址） |
  | /oauth/error          | 授权出错的端点                                               |
  | /oauth/check_token    | 校验 access_token 的端点                                     |
  | /oauth/token_key      | 提供公钥的端点                                               |


##### 接口演示

现在所有的接口如下，最下面关于其中关于user的接口是测试接口是被需要验证的。

![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\接口.png)

  - **获得 token，其中的用户是我预先插入MongoDB数据库的**

    ![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\1.png)

    ```shell
    在这里，access_token就是获得的token，refresh_token是刷新时候用的，expires_in是有效期
    ```

  - **用access_token使用接口**

    首先写一个简单的接口，参数就是HttpSevletRequest

    ![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\2.png)

    Postman请求一下

    ![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\用户管理模块文档\3.png)

    或者也可以这样，但是得有Authorization

    ![4](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\4.png)

    ![5](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\5.png)

  - **刷新token**

    参数grant_type为refresh_token，refresh_token值为上面获得的refresh_token，还必须有authentication值（其实就是获得token的第二种传参方式）

    ![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\6.png)

    
    ![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\7.png)

    下面这种请求也可以
    
    ![](D:\code\java\SysDesignBig\watup-messenger\usermanaging\readme\用户管理模块文档\8.png)

##### 未完待续。。。





